DROP TABLE taught_by CASCADE CONSTRAINTS;
DROP TABLE performance CASCADE CONSTRAINTS;
DROP TABLE teacher CASCADE CONSTRAINTS;
DROP TABLE enrollment CASCADE CONSTRAINTS;
DROP TABLE next_of_kin CASCADE CONSTRAINTS;
DROP TABLE student CASCADE CONSTRAINTS;
DROP TABLE module CASCADE CONSTRAINTS;
DROP TABLE course CASCADE CONSTRAINTS;
DROP TABLE academic_staff CASCADE CONSTRAINTS;
DROP TABLE department CASCADE CONSTRAINTS;
SET DEFINE OFF;
-- ============================================================
-- PART A: CREATE TABLES (parents first, junctions last)
-- ============================================================
-- 1) DEPARTMENT (Create WITHOUT FK to academic_staff to avoid circular dependency)
CREATE TABLE department (
  dept_no            NUMBER(4)       CONSTRAINT pk_department PRIMARY KEY,
  name               VARCHAR2(50)    NOT NULL,
  phone              VARCHAR2(15),
  fax                VARCHAR2(15),
  location           VARCHAR2(20),
  manager_staff_no   NUMBER(6),     -- FK added later to avoid circular dependency
  manager_start_date DATE
);
-- 2) ACADEMIC_STAFF (each staff works for one department)
CREATE TABLE academic_staff (
  staff_no       NUMBER(6)       CONSTRAINT pk_academic_staff PRIMARY KEY,
  f_name         VARCHAR2(50)    NOT NULL,
  l_name         VARCHAR2(50)    NOT NULL,
  phone_ext      VARCHAR2(10),
  office_no      VARCHAR2(20),
  sex            CHAR(1)         CONSTRAINT chk_staff_sex CHECK (sex IN ('M','F')),
  salary         NUMBER(9,2)     CONSTRAINT chk_staff_salary CHECK (salary >= 0),
  post           VARCHAR2(50),
  qualifications VARCHAR2(100),
  address        VARCHAR2(120),
  dept_no        NUMBER(4)       NOT NULL,
  user_id        VARCHAR2(30)    NOT NULL,
  CONSTRAINT uq_staff_user UNIQUE (user_id),
  CONSTRAINT fk_staff_dept FOREIGN KEY (dept_no) REFERENCES department (dept_no)
);
-- 3) COURSE (managed by a staff member, lives in a department)
CREATE TABLE course (
  course_code      VARCHAR2(10)  CONSTRAINT pk_course PRIMARY KEY,
  title            VARCHAR2(100) NOT NULL,
  duration_years   NUMBER(2)     CONSTRAINT chk_course_duration CHECK (duration_years >= 1),
  dept_no          NUMBER(4)     NOT NULL,
  leader_staff_no  NUMBER(6),    -- a staff can lead at most one course
  CONSTRAINT fk_course_dept   FOREIGN KEY (dept_no)        REFERENCES department (dept_no),
  CONSTRAINT fk_course_leader FOREIGN KEY (leader_staff_no) REFERENCES academic_staff (staff_no),
  CONSTRAINT uq_course_leader UNIQUE (leader_staff_no)
);
-- 4) MODULE (belongs to exactly one course; coordinated by a staff member)
CREATE TABLE module (
  module_code          VARCHAR2(10) CONSTRAINT pk_module PRIMARY KEY,
  title                VARCHAR2(100) NOT NULL,
  start_date           DATE          NOT NULL,
  end_date             DATE          NOT NULL,
  texts                VARCHAR2(200),
  assessment_scheme    VARCHAR2(100),
  course_code          VARCHAR2(10)  NOT NULL,
  coordinator_staff_no NUMBER(6),
  CONSTRAINT chk_module_dates CHECK (start_date <= end_date),
  CONSTRAINT fk_module_course      FOREIGN KEY (course_code)          REFERENCES course (course_code),
  CONSTRAINT fk_module_coordinator FOREIGN KEY (coordinator_staff_no) REFERENCES academic_staff (staff_no)
);
-- 5) STUDENT (enrolled in exactly one course at a time)
CREATE TABLE student (
  matric_no      VARCHAR2(10)  CONSTRAINT pk_student PRIMARY KEY,
  f_name         VARCHAR2(50)  NOT NULL,
  l_name         VARCHAR2(50)  NOT NULL,
  street         VARCHAR2(100),
  town           VARCHAR2(50),
  postcode       VARCHAR2(10),
  dob            DATE,
  sex            CHAR(1)       CONSTRAINT chk_student_sex CHECK (sex IN ('M','F')),
  financial_loan NUMBER(9,2)   CONSTRAINT chk_student_loan CHECK (financial_loan >= 0),
  course_code    VARCHAR2(10)  NOT NULL,
  user_id        VARCHAR2(30)  NOT NULL,
  CONSTRAINT uq_student_user UNIQUE (user_id),
  CONSTRAINT fk_student_course FOREIGN KEY (course_code) REFERENCES course (course_code)
);
-- 6) NEXT_OF_KIN (1:1 with student, per brief)
CREATE TABLE next_of_kin (
  kin_id            NUMBER(6)      CONSTRAINT pk_next_of_kin PRIMARY KEY,
  name              VARCHAR2(100)  NOT NULL,
  address           VARCHAR2(120),
  phone             VARCHAR2(15),
  relationship      VARCHAR2(20),
  student_matric_no VARCHAR2(10)   NOT NULL,
  CONSTRAINT fk_kin_student    FOREIGN KEY (student_matric_no) REFERENCES student (matric_no),
  CONSTRAINT uq_kin_student    UNIQUE (student_matric_no)
);
-- 7) ENROLLMENT (junction: student ↔ course; one active course per student)
CREATE TABLE enrollment (
  enrollment_id     NUMBER(8)     CONSTRAINT pk_enrollment PRIMARY KEY,
  enrollment_date   DATE          NOT NULL,
  grade             VARCHAR2(10), -- keep generic; can be NULL
  student_matric_no VARCHAR2(10)  NOT NULL,
  course_code       VARCHAR2(10)  NOT NULL,
  CONSTRAINT fk_enroll_student FOREIGN KEY (student_matric_no) REFERENCES student (matric_no),
  CONSTRAINT fk_enroll_course  FOREIGN KEY (course_code)       REFERENCES course (course_code),
  CONSTRAINT uq_enroll_student_course UNIQUE (student_matric_no, course_code)
);
-- 8) TEACHER (junction: staff ↔ module; hours per week)
CREATE TABLE teacher (
  staff_no       NUMBER(6)     NOT NULL,
  module_code    VARCHAR2(10)  NOT NULL,
  hours_per_week NUMBER(4,1)   CONSTRAINT chk_teacher_hours CHECK (hours_per_week >= 0),
  CONSTRAINT pk_teacher PRIMARY KEY (staff_no, module_code),
  CONSTRAINT fk_teacher_staff  FOREIGN KEY (staff_no)    REFERENCES academic_staff (staff_no),
  CONSTRAINT fk_teacher_module FOREIGN KEY (module_code) REFERENCES module (module_code)
);
-- 9) PERFORMANCE (junction: student ↔ module; Pass/Fail record)
CREATE TABLE performance (
  matric_no    VARCHAR2(10)  NOT NULL,
  module_code  VARCHAR2(10)  NOT NULL,
  performance  VARCHAR2(10)  NOT NULL,
  CONSTRAINT chk_performance_val CHECK (performance IN ('Pass','Fail')),
  CONSTRAINT pk_performance PRIMARY KEY (matric_no, module_code),
  CONSTRAINT fk_perf_student FOREIGN KEY (matric_no)   REFERENCES student (matric_no),
  CONSTRAINT fk_perf_module  FOREIGN KEY (module_code) REFERENCES module (module_code)
);


-- TAUGHT_BY (Staff ↔ Module)
-- ============================================================
CREATE TABLE taught_by (
  staff_no    NUMBER(6)    NOT NULL,
  module_code VARCHAR2(10) NOT NULL,
  CONSTRAINT pk_taught_by PRIMARY KEY (staff_no, module_code),
  CONSTRAINT fk_taughtby_staff  FOREIGN KEY (staff_no)
    REFERENCES academic_staff (staff_no),
  CONSTRAINT fk_taughtby_module FOREIGN KEY (module_code)
    REFERENCES module        (module_code)
);

-- 10) Add the circular FK (department.manager_staff_no → academic_staff.staff_no)
--     This must be done after both tables exist.
ALTER TABLE department
  ADD CONSTRAINT fk_dept_manager
  FOREIGN KEY (manager_staff_no)
  REFERENCES academic_staff (staff_no);
-- (Optional) enforce "a staff manages at most one department"
ALTER TABLE department
  ADD CONSTRAINT uq_dept_manager UNIQUE (manager_staff_no);
